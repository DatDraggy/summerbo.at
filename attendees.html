<?php
require_once('backend/config.php');
require_once('backend/funcs.php');
require_once('backend/includes.php');
header('Cache-Control: max-age=0');

$dbConnection = buildDatabaseConnection($config);

$showButtons = false;
if (getConfirmedAttendees() < $config['attendeesMax']) {
  $showButtons = true;
}

$sql = 'SELECT nickname, `rank`, sponsor FROM users WHERE status > 1 AND list = true ORDER BY nickname';
$stmt = $dbConnection->prepare($sql);
$stmt->execute();
$rows = $stmt->fetchAll();
$attendees = '<ul>';
foreach ($rows as $row) {
  $nickname = htmlspecialchars($row['nickname']);
  if ($row['rank'] == 1) {
    $nickname .= ' <span class="rank">Crew</span>';
  } else if ($row['rank'] >= 2) {
    $nickname .= ' <span class="rank">Staff</span>';
  } else if ($row['sponsor'] == 1) {
    $nickname .= ' <span class="rank">VIP</span>';
  }
  $attendees .= '<li>' . $nickname . "</li>\n";
}
$attendees .= '</ul>';

$data['country'] = array();
$label['country'] = array();
$data['age'] = array();
$label['age'] = array();

$sql = "SELECT country, count(country) as count FROM users WHERE status > 1 GROUP BY country ORDER BY count DESC";
$stmt = $dbConnection->prepare($sql);
$stmt->execute();
$rows = $stmt->fetchAll();

foreach ($rows as $row) {
  $data['country'][] = $row['count'];
  $label['country'][] = $row['country'];
}

$sql = "SELECT age, COUNT(id) AS count FROM (SELECT id, YEAR('2019-08-13') - YEAR(STR_TO_DATE(dob, '%Y-%m-%d')) - (RIGHT('2019-08-13', 5) < RIGHT(STR_TO_DATE(dob, '%Y-%m-%d'), 5)) AS age FROM users) as Z GROUP BY age ORDER BY age ASC";
$stmt = $dbConnection->prepare($sql);
$stmt->execute();
$rows = $stmt->fetchAll();

$label['age'][] = 'Ages';
foreach ($rows as $row) {
  $data['age'][] = array("x"=>$row['age'], "y"=>$row['count']);
}

$sql = "SELECT (SELECT count(id) FROM users WHERE fursuiter = 1) as fursuiter,(SELECT count(id) FROM users WHERE fursuiter = 0) as attendees";
$stmt = $dbConnection->prepare($sql);
$stmt->execute();
$row = $stmt->fetch();

$data['fur'][] = $row['fursuiter'];
$label['fur'][] = 'Fursuit';
$data['fur'][] = $row['attendees'];
$label['fur'][] = 'No Fursuit';

$sql = "SELECT (SELECT count(id) FROM users WHERE sponsor = 1) as sponsors,(SELECT count(id) FROM users WHERE sponsor = 0) as attendees";
$stmt = $dbConnection->prepare($sql);
$stmt->execute();
$row = $stmt->fetch();

$data['vip'][] = $row['sponsors'];
$label['vip'][] = 'VIP';
$data['vip'][] = $row['attendees'];
$label['vip'][] = 'No VIP';

$sql = "SELECT (SELECT count(id) FROM users WHERE fursuiter = 1 AND sponsor = 1) as sponsors,(SELECT count(id) FROM users WHERE fursuiter = 1 AND sponsor = 0) as fursuiter";
$stmt = $dbConnection->prepare($sql);
$stmt->execute();
$row = $stmt->fetch();

$data['vip2'][] = $row['sponsors'];
$label['vip2'][] = 'VIP';
$data['vip2'][] = $row['fursuiter'];
$label['vip2'][] = 'No VIP';

?>
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <title>Hot Summer Nights: Furry Summerbo.at Party</title>
    <?php echo $head; ?>
    <style>.rank {
        color: lightgrey
      }</style>
    <script src="/js/chart.min.js"></script>
    <script>
      window.onload = function () {
        var ctxCountry = document.getElementById("attendanceByCountry");
        var ctxAge = document.getElementById("attendanceByAge");
        var ctxAttFur = document.getElementById("attendeeToFursuiter");
        var ctxAttVip = document.getElementById("attendeeToVip");
        var ctxFurVip = document.getElementById("fursuiterToVip");
        var myChartCountry = new Chart(ctxCountry, {
          type: 'bar',
          data: {
            labels: <?=json_encode($label['country'])?>,
            datasets: [{
              label: 'Attendees',
              data: <?=json_encode($data['country'])?>,
              borderWidth: 1,
              backgroundColor: [
                'rgba(25,215,23, 0.2)',
                'rgba(11,214,148, 0.2)',
                'rgba(194,190,204, 0.2)',
                'rgba(24,84,204, 0.2)',
                'rgba(165,148,170, 0.2)',
                'rgba(145,226,48, 0.2)',
                'rgba(29,249,242, 0.2)',
                'rgba(70,45,235, 0.2)',
                'rgba(242,28,143, 0.2)',
                'rgba(85,138,246, 0.2)'
              ]
            }]
          },
          options: {
            scales: {
              yAxes: [{
                ticks: {
                  beginAtZero: true
                }
              }]
            }
          }
        });
        var myChartAge = new Chart(ctxAge, {
          type: 'scatter',
          data: {
            labels: <?=json_encode($label['age'])?>,
            datasets: [{
              label: 'Ages',
              data: <?=json_encode($data['age'])?>,
              borderWidth: 1,
              backgroundColor: [
                'rgba(235,66,116, 1)'
              ]
            }]
          },
          options: {
            scales: {
              xAxes: [{
                ticks: {
                  stepSize: 1
                },
                scaleLabel: {
                  display: true,
                  labelString: 'Age'
                }
              }],
              yAxes: [{
                scaleLabel: {
                  display: true,
                  labelString: 'Amount'
                }
              }]
            }
          }
        });
        var myChartAttFur = new Chart(ctxAttFur, {
          type: 'pie',
          data: {
            labels: <?=json_encode($label['fur'])?>,
            datasets: [{
              data: <?=json_encode($data['fur'])?>,
              borderWidth: 1,
              backgroundColor: [
                'rgba(235,66,116, 1)',
                'rgba(59,63,158, 1)'
              ]
            }]
          }
        });
        var myChartAttVip = new Chart(ctxAttVip, {
          type: 'pie',
          data: {
            labels: <?=json_encode($label['vip'])?>,
            datasets: [{
              data: <?=json_encode($data['vip'])?>,
              borderWidth: 1,
              backgroundColor: [
                'rgba(235,66,116, 1)',
                'rgba(59,63,158, 1)'
              ]
            }]
          }
        });
        var myChartFurVip = new Chart(ctxFurVip, {
          type: 'pie',
          data: {
            labels: <?=json_encode($label['vip2'])?>,
            datasets: [{
              data: <?=json_encode($data['vip2'])?>,
              borderWidth: 1,
              backgroundColor: [
                'rgba(235,66,116, 1)',
                'rgba(59,63,158, 1)'
              ]
            }]
          }
        });
      }
    </script>
  </head>
  <body class="hasNav">
    <div id="app">
      <?php echo $nav; ?>

      <section id="contentPage">
        <!-- ========== Info text ========== -->

        <section id="about" class="ribbon" style="background-color: var(--colorPink)">
          <div class="wrapper">
            <div class="row">
              <div style="color:white" class="content wsLarge">
                <h1>Attendee List</h1>
                <?php if ($showButtons) { ?>
                  <p class="textBig">The one and only crew list for the boatparty! All people on this list are going to party hard on the coolest ship of Berlin. Don't see yourself yet?</p>
                  <div class="buttonGroup">
                    <a class="button buttonPrimary" href="register" title="Get a ticket">Register
                      Now</a>
                    <a class="button buttonUpgrade" href="register?vip" title="Upgrade to VIP">Upgrade to VIP</a>
                  </div>
                <?php } else { ?>
                  <p class="textBig">The one and only crew list for the boatparty! All people on this list are going to party hard on the coolest ship of Berlin.</p>
                <?php } ?>
              </div>
            </div>
          </div>
        </section>

        <section class="wrapper wsLarge">
          <div class="row">
            <div class="content">
              <h2 id="faq" class="headline heading1">Statistics</h2>
            </div>
          </div>
          <div class="row" style="display: block;">
            <div class="content">
              <dl class="js-badger-accordion">
                <dt>
                  <button class="buttonClr textBig js-badger-accordion-header">
                    Attendance by Country
                  </button>
                </dt>
                <dd class="badger-accordion__panel js-badger-accordion-panel" style="max-width: none">
                  <div class="js-badger-accordion-panel-inner">
                    <div class="chart-container" style="position: relative; height:400px; width:800px">
                      <canvas id="attendanceByCountry"></canvas>
                    </div>
                  </div>
                </dd>
              </dl>
              <dl class="js-badger-accordion">
                <dt>
                  <button class="buttonClr textBig js-badger-accordion-header">
                    Attendance by Age
                  </button>
                </dt>
                <dd class="badger-accordion__panel js-badger-accordion-panel" style="max-width: none">
                  <div class="js-badger-accordion-panel-inner">
                    <div class="chart-container" style="position: relative; height:400px; width:800px">
                      <canvas id="attendanceByAge"></canvas>
                    </div>
                  </div>
                </dd>
              </dl>
              <dl class="js-badger-accordion">
                <dt>
                  <button class="buttonClr textBig js-badger-accordion-header">
                    Attendee to Fursuiter Ratio
                  </button>
                </dt>
                <dd class="badger-accordion__panel js-badger-accordion-panel" style="max-width: none">
                  <div class="js-badger-accordion-panel-inner">
                    <div class="chart-container" style="position: relative; height:400px; width:400px">
                      <canvas id="attendeeToFursuiter"></canvas>
                    </div>
                  </div>
                </dd>
              </dl>
              <dl class="js-badger-accordion">
                <dt>
                  <button class="buttonClr textBig js-badger-accordion-header">
                    Attendee to VIP Ratio
                  </button>
                </dt>
                <dd class="badger-accordion__panel js-badger-accordion-panel" style="max-width: none">
                  <div class="js-badger-accordion-panel-inner">
                    <div class="chart-container" style="position: relative; height:400px; width:400px">
                      <canvas id="attendeeToVip"></canvas>
                    </div>
                  </div>
                </dd>
              </dl>
              <dl class="js-badger-accordion">
                <dt>
                  <button class="buttonClr textBig js-badger-accordion-header">
                    Fursuiter to VIP Ratio
                  </button>
                </dt>
                <dd class="badger-accordion__panel js-badger-accordion-panel" style="max-width: none">
                  <div class="js-badger-accordion-panel-inner">
                    <div class="chart-container" style="position: relative; height:400px; width:400px">
                      <canvas id="fursuiterToVip"></canvas>
                    </div>
                  </div>
                </dd>
              </dl>
            </div>
          </div>
          <div class="row">
            <h2 class="headline">Attendees</h2>
          </div>
          <div class="row" id="attendeeList">
            <?php echo $attendees; ?>
          </div>
        </section>
      </section> <!--pageWrapper -->
      <?php echo $footer; ?>
  </body>
</html>
