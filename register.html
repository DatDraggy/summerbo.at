<?php
require_once('files/config.php');
if (!empty($_POST['firstname'])) {
  $firstNamePost = $_POST['firstname'];
} else {
  die('no first name');
}
if (!empty($_POST['lastname'])) {
  $lastNamePost = $_POST['lastname'];
} else {
  die('no last name');
}
if (!empty($_POST['nickname'])) {
  $nicknamePost = $_POST['nickname'];
} else {
  die('no nickname');
}
if (!empty($_POST['dateofbirth'])) {
  $dobPost = $_POST['dateofbirth'];
} else {
  die('no date of birth');
}
if (!empty($_POST['fursuiter'])) {
  $fursuiter = true;
} else {
  $fursuiter = false;
}
if (!empty($_POST['sponsor'])) {
  $sponsor = true;
} else {
  $sponsor = false;
}
if (!empty($_POST['email'])) {
  $emailPost = $_POST['email'];
} else {
  die('no email');
}
if (!empty($_POST['password'])) {
  $passwordPost = $_POST['password'];
} else {
  die('no password');
}
if (!empty($_POST['passwordVerify'])) {
  $passwordVerifyPost = $_POST['passwordVerify'];
} else {
  die('no password verify');
}
if (!empty($_POST['country'])) {
  $countryPost = $_POST['country'];
} else {
  die('no country');
}
if (!empty($_POST['tos'])) {
  $tos = true;
} else {
  $tos = false;
}
if (!empty($_POST['publicList'])) {
  $publicList = true;
} else {
  $publicList = false;
}

if (preg_match('/[\sa-zA-Z]/', $firstNamePost) !== 1) {
  echo 'Illegal Char in First Name';
} else {
  $firstName = $firstNamePost;
}

if (preg_match('/[\sa-zA-Z]/', $lastNamePost) !== 1) {
  echo 'Illegal Char in Last Name';
} else {
  $lastName = $lastNamePost;
}

//$nicknameRaw = str_replace(' ', '_', $nicknamePost);
$nicknameRaw = $nicknamePost;
$nickname = preg_replace('/[^\w-. ~]/', '', $nicknameRaw);

$dobStamp = strtotime($dobPost);
if ($dobStamp === false) {
  die('Invalid Birthdate Format. Please use the following format: 2000-05-31');
}
$dob = date('Y-m-d', $dobStamp);

if (filter_var($emailPost, FILTER_VALIDATE_EMAIL)) {
  $email = $emailPost;
} else {
  die('Invalid Email');
}

if ($passwordPost !== $passwordVerifyPost) {
  die('Do not match');
}
$passValid = validatePassword($passwordPost);
if ($passValid !== true) {
  die('Password invalid because ' . $passValid);
} else {
  $password = $passwordPost;
}
$hash = hashPassword($password);

if (strlen($countryPost) == 2) {
  $country = preg_replace('/[A-Z]/', '', $countryPost);
}

$dbConnection = buildDatabaseConnection($config);
if($dbConnection === false){
  die('Broken Database Connection');
}

$userId = newRegistration($firstName, $lastName, $nickname, $dob, $fursuiter, $sponsor, $email, $hash, $country, 0, time(), $publicList);
if($userId === false){
  die('Reg failed for some reason');
}
requestRegistrationConfirm($userId, $email);

echo 'Done. You\'ve got mail';
?>





















